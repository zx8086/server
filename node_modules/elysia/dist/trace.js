let e=()=>{let e;let s=new Promise(s=>{e=s});return[s,e]},s=()=>{let[s,n]=e(),[r,t]=e(),a=[],i=[];return{signal:s,consume:s=>{switch(s.type){case"begin":if(s.unit&&0===a.length)for(let n=0;n<s.unit;n++){let[s,n]=e(),[r,t]=e();a.push(s),i.push([e=>{n({children:[],end:r,name:e.name??"",skip:!1,time:e.time})},e=>{t(e)}])}n({children:a,end:r,name:s.name??"",skip:!1,time:s.time});break;case"end":t(s.time)}},consumeChild(e){switch(e.type){case"begin":if(!i[0])return;let[s]=i[0];s({children:[],end:r,name:e.name??"",skip:!1,time:e.time});break;case"end":let n=i.shift();if(!n)return;n[1](e.time)}},resolve(){for(let[e,s]of(n({children:[],end:new Promise(e=>e(0)),name:"",skip:!0,time:0}),i))e({children:[],end:new Promise(e=>e(0)),name:"",skip:!0,time:0}),s(0);t(0)}}};export const createTraceListener=(e,n,r)=>async function(t){if("request"!==t.event||"begin"!==t.type)return;let a=t.id,i=e(),o=s(),l=s(),c=s(),m=s(),u=s(),d=s(),b=s(),k=s();o.consume(t);let f=e=>{if(e.id===a)switch(e.event){case"request":o.consume(e);break;case"request.unit":o.consumeChild(e);break;case"parse":l.consume(e);break;case"parse.unit":l.consumeChild(e);break;case"transform":c.consume(e);break;case"transform.unit":c.consumeChild(e);break;case"beforeHandle":m.consume(e);break;case"beforeHandle.unit":m.consumeChild(e);break;case"handle":u.consume(e);break;case"afterHandle":d.consume(e);break;case"afterHandle.unit":d.consumeChild(e);break;case"error":b.consume(e);break;case"error.unit":b.consumeChild(e);break;case"response":"begin"===e.type?(o.resolve(),l.resolve(),c.resolve(),m.resolve(),u.resolve(),d.resolve(),b.resolve()):i.off("event",f),k.consume(e);break;case"response.unit":k.consumeChild(e);break;case"exit":o.resolve(),l.resolve(),c.resolve(),m.resolve(),u.resolve(),d.resolve(),b.resolve()}};i.on("event",f),await r({id:a,// @ts-ignore
    context:t.ctx,// @ts-ignore
    set:t.ctx?.set,// @ts-ignore
    store:t.ctx?.store,time:t.time,request:o.signal,parse:l.signal,transform:c.signal,beforeHandle:m.signal,handle:u.signal,afterHandle:d.signal,error:b.signal,response:k.signal}),i.emit(`res${a}.${n}`,void 0)};