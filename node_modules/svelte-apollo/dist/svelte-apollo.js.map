{"version":3,"file":"svelte-apollo.js","sources":["../src/context.ts","../src/mutation.ts","../src/observable.ts","../src/restore.ts","../src/query.ts","../src/subscribe.ts"],"sourcesContent":["import type { ApolloClient } from \"@apollo/client/core\";\nimport { getContext, setContext } from \"svelte\";\n\nconst CLIENT = typeof Symbol !== \"undefined\" ? Symbol(\"client\") : \"@@client\";\n\nexport function getClient<TCache = any>(): ApolloClient<TCache> {\n\tconst client = getContext(CLIENT);\n\n\tif (!client) {\n\t\tthrow new Error(\n\t\t\t\"ApolloClient has not been set yet, use setClient(new ApolloClient({ ... })) to define it\"\n\t\t);\n\t}\n\n\treturn client as ApolloClient<TCache>;\n}\n\nexport function setClient<TCache = any>(client: ApolloClient<TCache>): void {\n\tsetContext(CLIENT, client);\n}\n","import type { FetchResult, MutationOptions } from \"@apollo/client/core\";\nimport type { DocumentNode } from \"graphql\";\nimport { getClient } from \"./context\";\n\nexport type MutateOptions<T = unknown, TVariables = unknown> = Omit<\n\tMutationOptions<T, TVariables>,\n\t\"mutation\"\n>;\n\nexport type Mutate<T = unknown, TVariables = unknown> = (\n\toptions: MutateOptions<T, TVariables>\n) => Promise<FetchResult<T>>;\n\nexport function mutation<T = unknown, TVariables = unknown>(\n\tmutation: DocumentNode,\n\tinitialOptions: MutateOptions<T, TVariables> = {}\n): Mutate<T, TVariables> {\n\tconst client = getClient();\n\n\treturn (options: MutateOptions<T, TVariables>) =>\n\t\tclient.mutate({ mutation, ...initialOptions, ...options });\n}\n","import { ApolloError } from \"@apollo/client/core\";\nimport type {\n\tFetchResult,\n\tObservable,\n\tObservableQuery,\n} from \"@apollo/client/core\";\nimport { readable } from \"svelte/store\";\nimport type { Readable } from \"svelte/store\";\n\n// Match Apollo's hook approach, by returning a result with three states:\n// loading, error, or data (where data could be null / undefined)\n\nexport interface LoadingState {\n\tloading: true;\n\tdata?: undefined;\n\terror?: undefined;\n}\nexport interface ErrorState {\n\tloading: false;\n\tdata?: undefined;\n\terror: ApolloError | Error;\n}\nexport interface DataState<TData = unknown> {\n\tloading: false;\n\tdata: TData | null | undefined;\n\terror?: undefined;\n}\n\nexport type Result<TData = unknown> =\n\t| LoadingState\n\t| ErrorState\n\t| DataState<TData>;\n\n// Some methods, e.g. subscription, use Observable<FetchResult>,\n// convert this more raw value to a readable\n\nexport type ReadableResult<TData = unknown> = Readable<Result<TData>>;\n\nexport function observableToReadable<TData = unknown>(\n\tobservable: Observable<FetchResult<TData>>,\n\tinitialValue: Result<TData> = {\n\t\tloading: true,\n\t\tdata: undefined,\n\t\terror: undefined,\n\t}\n): ReadableResult<TData> {\n\tconst store = readable<Result<TData>>(initialValue, (set) => {\n\t\tconst skipDuplicate = initialValue?.data !== undefined;\n\t\tlet skipped = false;\n\n\t\tconst subscription = observable.subscribe(\n\t\t\t(result: FetchResult<TData>) => {\n\t\t\t\tif (skipDuplicate && !skipped) {\n\t\t\t\t\tskipped = true;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (result.errors) {\n\t\t\t\t\tconst error = new ApolloError({ graphQLErrors: result.errors });\n\t\t\t\t\tset({ loading: false, data: undefined, error });\n\t\t\t\t} else {\n\t\t\t\t\tset({ loading: false, data: result.data, error: undefined });\n\t\t\t\t}\n\t\t\t},\n\t\t\t(error: any) =>\n\t\t\t\tset({\n\t\t\t\t\tloading: false,\n\t\t\t\t\tdata: undefined,\n\t\t\t\t\terror: error && \"message\" in error ? error : new Error(error),\n\t\t\t\t})\n\t\t);\n\n\t\treturn () => subscription.unsubscribe();\n\t});\n\n\treturn store;\n}\n\n// For live queries, ObservableQuery is used, adding methods like refetch\n// extend readable with these methods\n\nexport interface ObservableQueryExtensions<TData = unknown> {\n\tfetchMore: ObservableQuery<TData>[\"fetchMore\"];\n\tgetCurrentResult: ObservableQuery<TData>[\"getCurrentResult\"];\n\tgetLastError: ObservableQuery<TData>[\"getLastError\"];\n\tgetLastResult: ObservableQuery<TData>[\"getLastResult\"];\n\tisDifferentFromLastResult: ObservableQuery<TData>[\"isDifferentFromLastResult\"];\n\trefetch: ObservableQuery<TData>[\"refetch\"];\n\tresetLastResults: ObservableQuery<TData>[\"resetLastResults\"];\n\tresetQueryStoreErrors: ObservableQuery<TData>[\"resetQueryStoreErrors\"];\n\tresult: ObservableQuery<TData>[\"result\"];\n\tsetOptions: ObservableQuery<TData>[\"setOptions\"];\n\tsetVariables: ObservableQuery<TData>[\"setVariables\"];\n\tstartPolling: ObservableQuery<TData>[\"startPolling\"];\n\tstopPolling: ObservableQuery<TData>[\"stopPolling\"];\n\tsubscribeToMore: ObservableQuery<TData>[\"subscribeToMore\"];\n\tupdateQuery: ObservableQuery<TData>[\"updateQuery\"];\n}\n\nexport const extensions: Array<keyof ObservableQueryExtensions> = [\n\t\"fetchMore\",\n\t\"getCurrentResult\",\n\t\"getLastError\",\n\t\"getLastResult\",\n\t\"isDifferentFromLastResult\",\n\t\"refetch\",\n\t\"resetLastResults\",\n\t\"resetQueryStoreErrors\",\n\t\"result\",\n\t\"setOptions\",\n\t\"setVariables\",\n\t\"startPolling\",\n\t\"stopPolling\",\n\t\"subscribeToMore\",\n\t\"updateQuery\",\n];\n\nexport type ReadableQuery<TData> = ReadableResult<TData> &\n\tObservableQueryExtensions<TData>;\n\nexport function observableQueryToReadable<\n\tTData = unknown,\n\tTVariables = unknown\n>(\n\tquery: ObservableQuery<TData, TVariables>,\n\tinitialValue?: Result<TData>\n): ReadableQuery<TData> {\n\tconst store = observableToReadable(\n\t\tquery,\n\t\tinitialValue\n\t) as ReadableQuery<TData>;\n\n\tfor (const extension of extensions) {\n\t\tstore[extension] = query[extension].bind(query) as any;\n\t}\n\n\treturn store;\n}\n","import type {\n\tApolloClient,\n\tDataProxy,\n\tOperationVariables,\n} from \"@apollo/client/core\";\nimport type { DocumentNode } from \"graphql\";\nimport { onMount } from \"svelte\";\nimport { getClient } from \"./context\";\n\nexport type Restoring<TCache> =\n\t| WeakSet<ApolloClient<TCache>>\n\t| Set<ApolloClient<TCache>>;\n\nexport const restoring: Restoring<unknown> =\n\ttypeof WeakSet !== \"undefined\" ? new WeakSet() : new Set();\n\nexport function restore<TData = unknown, TVariables = OperationVariables>(\n\tquery: DocumentNode,\n\toptions: Omit<DataProxy.WriteQueryOptions<TData, TVariables>, \"query\">\n): void {\n\tconst client = getClient();\n\n\trestoring.add(client);\n\tafterHydrate(() => restoring.delete(client));\n\n\tclient.writeQuery({ query, ...options });\n}\n\nfunction afterHydrate(callback: () => void): void {\n\t// Attempt to wait for onMount (hydration of current component is complete),\n\t// but if that fails (e.g. outside of component initialization)\n\t// wait for next event loop for hydrate to complete\n\n\ttry {\n\t\tonMount(callback);\n\t} catch (_error) {\n\t\tsetTimeout(callback, 1);\n\t}\n}\n","import type { WatchQueryOptions } from \"@apollo/client/core\";\nimport type { DocumentNode } from \"graphql\";\nimport { getClient } from \"./context\";\nimport { DataState, observableQueryToReadable } from \"./observable\";\nimport type { ReadableQuery } from \"./observable\";\nimport { restoring } from \"./restore\";\n\nexport function query<TData = unknown, TVariables = unknown>(\n\tquery: DocumentNode,\n\toptions: Omit<WatchQueryOptions<TVariables, TData>, \"query\"> = {}\n): ReadableQuery<TData> {\n\tconst client = getClient();\n\tconst queryOptions = { ...options, query } as WatchQueryOptions<\n\t\tTVariables,\n\t\tTData\n\t>;\n\n\t// If client is restoring (e.g. from SSR), attempt synchronous readQuery first\n\tlet initialValue: TData | undefined;\n\tif (restoring.has(client)) {\n\t\ttry {\n\t\t\t// undefined = skip initial value (not in cache)\n\t\t\tinitialValue = client.readQuery(queryOptions) || undefined;\n\t\t} catch (err) {\n\t\t\t// Ignore preload errors\n\t\t}\n\t}\n\n\tconst observable = client.watchQuery<TData, TVariables>(queryOptions);\n\tconst store = observableQueryToReadable(\n\t\tobservable,\n\t\tinitialValue !== undefined\n\t\t\t? ({\n\t\t\t\t\tdata: initialValue,\n\t\t\t  } as DataState<TData>)\n\t\t\t: undefined\n\t);\n\n\treturn store;\n}\n","import type { SubscriptionOptions } from \"@apollo/client/core\";\nimport type { DocumentNode } from \"graphql\";\nimport { getClient } from \"./context\";\nimport { observableToReadable } from \"./observable\";\nimport type { ReadableResult } from \"./observable\";\n\nexport function subscribe<TData = unknown, TVariables = unknown>(\n\tquery: DocumentNode,\n\toptions: Omit<SubscriptionOptions<TVariables>, \"query\"> = {}\n): ReadableResult<TData> {\n\tconst client = getClient();\n\tconst observable = client.subscribe<TData, TVariables>({ query, ...options });\n\n\treturn observableToReadable<TData>(observable);\n}\n"],"names":[],"mappings":"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"}